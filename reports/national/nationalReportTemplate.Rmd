---
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: flatly
    number_sections: false
    self_contained: false
    lib_dir: ../../docs/countries/libs
    includes:
      in_header: ../../docs/resources/header.html
      after_body: ../../docs/resources/footer.html
params:
  country: Afghanistan
title: "National Perspective Daily Update"
subtitle: "`r params$country`"
---

```{r setup, include=F}
# Set R Markdown Options
knitr::opts_chunk$set(echo = F, 
                      message = F, 
                      warning = F,
                      echo = FALSE,
                      fig.align = "center",
                      out.width = "100%",
                      dev='png')

# Avoid numbers being rounded
options(scipen = 999)

# Laod packages
library(here)
library(readr)
library(tidyverse)
library(sf)
library(maps)
library(gganimate)
library(patchwork)
library(ggthemr)
library(grid)
library(magick)
library(plotly)
library(emojifont)

# devtools::install_github('cttobin/ggthemr')
ggthemr("light", type = 'inner')

# Load functions stored in functions file
files.sources = list.files(here::here("functions"))
invisible(sapply(files.sources, function(x) source(here::here("functions", x))))

# Setup captions
caption <- glue::glue("Data Source: John Jopkins University
                         Data updated on {date}
                         CC BY 4.0 Michael Harper 2020", date = format(Sys.time(), '%d %B %Y'))

current_date <- glue::glue("Data updated on {date}", date = format(Sys.time(), '%d %B %Y'))

# Setup Text
df <- readr::read_csv(here::here("data/global/covid_data_global.csv"),
                      col_types = readr::cols()) %>%
  mutate(continent = factor(continent, levels = rev(c("Asia", "Europe", "North America", "South America", "Africa", "Oceania"))))

df_all <- loadData(spatial = T)
world_map <- loadWorldMap()
```



```{r}
df_country <- df_all %>%
  filter(region == params$country)

# Calculate metrics
deaths <-
  df_country %>%
  filter(date == max(date)) %>%
  filter(type == "deaths") %>%
  pull(value)

deaths_7_days_ago <- 
  df_country %>%
  filter(date == max(df$date) - lubridate::ddays(7)) %>%
  filter(type == "deaths") %>%
  pull(value)

cases <- 
  df_country %>%
  filter(date == max(date)) %>%
  filter(type == "cases") %>%
  pull(value)

cases_7_days_ago <-
  df_country %>%
  filter(date == max(df$date) - lubridate::ddays(7)) %>%
  filter(type == "cases") %>%
  pull(value)

```


```{r}
p2 <- 
  df_country %>%
  filter(type != "recovered") %>%
  ggplot(aes(x = date, y = value, colour = type)) +
  geom_line() +
  labs(title = glue::glue("Cumulative Cases and Deaths for {country}", country = params$country),
       subtitle = glue::glue("Total number of confirmed cases: {cases}
       Total number of deaths: {deaths}", deaths = deaths, cases = cases)) +
  theme(legend.position = "top",
        panel.grid.minor = element_line(linetype = "dashed", colour = "grey90", size = 0.4),
        panel.grid.major = element_line(linetype = "solid", colour = "grey90")) +
  scale_y_log10(minor_breaks = c(c(1:9) *10, c(1:9) *100, c(1:9) *1000, c(1:9) *10000))
p2
```

```{r fig.height=4, fig.width=6}

# Only show since 200th outbreak
df_country_bar <- df_country %>%
  filter(daysSince200Outbreak > 0)

if(nrow(df_country_bar) > 0){
  
  p2 <- ggplot(df_country_bar) + 
  geom_col(aes(x = date, y = changeDaily, fill = type), colour = "grey90") +
  labs(title = "Daily number of recorded cases and deaths",
       y = "Number",
       x = "Date",
       subtitle = glue::glue("Total number of confirmed cases: {cases}
       Total number of deaths: {deaths}", deaths = deaths, cases = cases)) +
  facet_grid(type~., scales = "free_y", labeller = labeller(type = function(x) tools::toTitleCase(x))) +
  scale_y_continuous(expand = c(0.1,0.1)) + 
  theme(panel.grid.major.x = element_blank(),
        legend.background = element_blank(),
        legend.position = "none")

p2
  
}


```

# Full Results

```{r}
df_country %>%
  sf::st_drop_geometry() %>%
  select(region, date, value, type) %>%
  tidyr::spread("type", "value") %>%
  DT::datatable()
```



